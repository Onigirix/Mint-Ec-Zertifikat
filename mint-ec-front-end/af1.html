<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Demo-Seite</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    overflow-y: hidden;
  }
  .header {
    display: flex;
    justify-content: space-between;
    padding: 10px 20px;
    background: #ccc;
  }
  .search-box {
    border: none;
    padding: 5px;
    margin-left: 45%;
  }
  .icon {
    width: 20px;
    height: 20px;
    background: #0000001c;
    display: inline-block;
    text-align: center;
  }
  .content {
    display: flex;
    height: 94vh;
  }
  .content-left {
    display: flex;
    width: 50vw;
    flex-direction: column;
    border: solid black 2px;
  }
  .sidebar {
    flex: 1;
    background: rgba(93, 153, 51, 0.6);
    padding: 20px;
    border: solid black 2px;
  }
  .main-content {
    flex: 1;
    background: rgba(190, 29, 29, 0.7);
    padding: 20px;
    border: solid black 2px;
  }
  .footer {
    flex:1;
    background: rgba(0, 129, 201, 0.7);
    padding: 20px;
    border: solid black 2px;
  }
  
  .schueler {
    position: absolute;
    left: 30%;
    padding: 20px;
    background: rgba(25, 25, 25, 0.8);
    width: 40%;
    border: 2px solid rgba(0, 0, 0, 0.9);
  }
  
  .box-container-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin-top: 10px;
  }
  
  .box {
    background-color: lightblue;
    border: 1px solid blue;
    padding: 10px;
    margin: 5px;
    width: 150px;
  }

  .boxzens {
    background-color: lightblue;
    border: 1px solid blue;
    padding: 10px;
    margin: 5px;
    width: 40px;
    text-align: center;
  }
  
  .circle-with-minus, .circle-with-plus {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: #000;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    cursor: pointer;
  }

  .button {
    margin-top: 10px;
    color: black;
    padding: 10px 10px;
    border: none;
    cursor: pointer;
    width: 30%;
    font-weight: bold;
    border: 1px solid black;
  }

  .label {
    color: white;
    padding-left: 10px;
  }
  
</style>
</head>
<body>

  <div class="header">
    <input id="schuelerholder"class="search-box" type="text" placeholder="Schüler...">
    <div>
      <span class="icon" style="position: absolute; left: 57%; top: 13px">+</span>
      <span class="icon"  style="position: absolute; left: 95%; top: 13px">&#128424;</span> <!-- Das Schloss-Symbol -->
      <span class="icon"  style="position: absolute; left: 97%; top: 13px">&#9881;</span> <!-- Das Schloss-Symbol -->
    </div>
  </div>

<div class="content">
  <div class="content-left">
    <div class="footer"></div>
    <div class="sidebar"></div>
  </div>

  <div class="main-content"></div>
  
  <div class="schueler">
    <div class="box-container-row">
      <h4 class="label">Fachliche Kompetenz:</h4>
      <h4 class="label" style="padding-left: 288px;">Ges. Dur</h4> 
      <h4 class="label" style="padding-left: 20px;">Stufe</h4> 
    </div>

    <div class="box-container-row" style="margin-top: -20px;">
      <input id="gesamt-dur" class="box" style="width: 60px; margin-left: 450px;" readonly>
      <input id="stufe" class="box" style="width: 60px; left: 100px; margin-top: 5px;" readonly>
    </div>

    <div class="box-container-row">
      <h4 class="label" style="padding-left: 25px;">erh.</h4> 
      <h4 class="label" style="padding-left: 280px;">Zensuren</h4> 
      <h4 class="label" style="padding-left: 130px;">Dur.</h4> 
    </div>
    
    <div id="rows-container">
      <!-- Die initiale Zeile -->
      <div class="box-container-row">
        <span class="circle-with-minus" onclick="removeRow(this)">&#8722;</span>
        <input type="checkbox" checked style="margin-right: 10px;" onchange="updateGesamtdurchschnitt()">
        <input class="box" type="text" placeholder="Text eingeben">
        <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
        <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
        <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
        <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
        <input class="box" type="text" readonly placeholder="Durchschnitt">
      </div>
    </div>

    <!-- Hinzufügen-Button -->
    <span class="circle-with-plus" onclick="addRow()">&#43;</span>
  </div>
</div>

<script>

var schueler = "";

  document.addEventListener('click', function (event) {
      var container = document.querySelector('.schueler');
      if (!container.contains(event.target)) {
        window.location.href = 'normal.html?Schueler=' + schueler;;
      }
    });

    function updateGesamtdurchschnitt() {
  const rows = document.querySelectorAll('#rows-container .box-container-row');
  let sum = 0;
  let count = 0;
  let validCheckboxes = 0;
  let rowsCount = 0;
  let sumNone = 0;
  let dataToSave = [];  // Array zum Speichern der Daten

  rows.forEach(row => {
    const checkbox = row.querySelector('input[type="checkbox"]');
    const avgBox = row.querySelectorAll('.box')[1]; 
    const name = row.querySelectorAll('.box')[0].value; 
    const zensuren = [...row.querySelectorAll('.boxzens')].map(zensur => zensur.value); 

    if (checkbox.checked && avgBox.value && parseFloat(avgBox.value) > 4) {
      sum += parseFloat(avgBox.value);
      count++;
      validCheckboxes++;
    }
    if (avgBox.value && !checkbox.checked && parseFloat(avgBox.value) > 4) {
      rowsCount++;
      sumNone += parseFloat(avgBox.value);
    }

    // Daten jeder Zeile speichern
    dataToSave.push({
      name: name || 'Unbekannt',
      zensuren: zensuren,
      durchschnitt: avgBox.value || 'N/A',
      aktiviert: checkbox.checked
    });
  });

  const gesamtDurBox = document.getElementById('gesamt-dur');
  const stufeBox = document.getElementById('stufe');

  if (validCheckboxes >= 2) {
    const gesamtDurchschnitt = (sum / count).toFixed(2);
    gesamtDurBox.value = gesamtDurchschnitt;
    let stufe = '';
    if (gesamtDurchschnitt >= 13) stufe = 'III';
    else if (gesamtDurchschnitt >= 11) stufe = 'II';
    else if (gesamtDurchschnitt >= 9) stufe = 'I';
    stufeBox.value = stufe;

    // arved narbeite -> array muss in der datenbank gespeichert werden, habs als console log simuliert
    console.log("Datenbankeintrag:");
    console.log({
      gesamtDurchschnitt: gesamtDurchschnitt,
      stufe: stufe,
      schuelerDaten: dataToSave
    });
  } else if (validCheckboxes === 1 && rowsCount === 2) {
    const gesamtDurchschnitt = ((sumNone + sum) / 3).toFixed(2);
    gesamtDurBox.value = gesamtDurchschnitt;
    let stufe = '';
    if (gesamtDurchschnitt >= 13) stufe = 'III';
    else if (gesamtDurchschnitt >= 11) stufe = 'II';
    else if (gesamtDurchschnitt >= 9) stufe = 'I';
    stufeBox.value = stufe;

   // arved narbeite -> array muss in der datenbank gespeichert werden, habs als console log simuliert
    console.log("Datenbankeintrag:");
    console.log({
      gesamtDurchschnitt: gesamtDurchschnitt,
      stufe: stufe,
      schuelerDaten: dataToSave
    });
  } else {
    gesamtDurBox.value = '';
    stufeBox.value = 'Fehler';
  }
}

  function addRow() {
    const container = document.getElementById('rows-container');
    
    const row = document.createElement('div');
    row.className = 'box-container-row';
    row.innerHTML = `
      <span class="circle-with-minus" onclick="removeRow(this)">&#8722;</span>
      <input type="checkbox" style="margin-right: 10px;" onchange="updateGesamtdurchschnitt()">
      <input class="box" type="text" placeholder="Text eingeben">
      <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
      <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
      <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
      <input class="boxzens" type="number" min="0" max="15" oninput="calculateAverage(this)">
      <input class="box" type="text" readonly placeholder="Durchschnitt">
    `;
    container.appendChild(row);
  }

  function removeRow(element) {
    const row = element.parentElement;
    row.remove();
    updateGesamtdurchschnitt();
  }

  function calculateAverage(input) {
    const row = input.parentElement;
    const zensuren = row.querySelectorAll('.boxzens');
    let sum = 0;
    let count = 0;

    zensuren.forEach(zensur => {
      const value = parseFloat(zensur.value);
      if (!isNaN(value)) {
        sum += value;
        count++;
      }
    });

    const avgBox = row.querySelectorAll('.box')[1]; // Der zweite .box für den Durchschnitt
    if (count > 0) {
      avgBox.value = (sum / count).toFixed(2); // Durchschnitt berechnen und auf 2 Dezimalstellen runden
    } else {
      avgBox.value = ''; // Wenn keine Zensuren eingegeben sind, das Feld leeren
    }

    updateGesamtdurchschnitt(); // Gesamtdurchschnitt nach jeder Änderung aktualisieren
  }

 
/*
  So habe cih die datenbank mal simuliert, idk ob das gut ist aber wäre wichtig wenn dus so änhlich oder so hast damit es passt

const datenbank = {
  "Paul Paulus": {
    gesamtDurchschnitt: 10.5,
    stufe: "II",
    schuelerDaten: [
      {
        name: "Mathe",
        zensuren: [12, 10, 13, 14],
        durchschnitt: 12.25,
        aktiviert: true
      },
      {
        name: "Deutsch",
        zensuren: [8, 9, 7, 10],
        durchschnitt: 8.5,
        aktiviert: false
      }
    ]
  }
};*/


function getSchuelerDaten(name) {
  return null; // hier musst du obvsl. deine datenbank anbinden
}


function fillData(daten) {
  if (!daten) return;

  const gesamtDurBox = document.getElementById('gesamt-dur');
  const stufeBox = document.getElementById('stufe');
  const rowsContainer = document.getElementById('rows-container');

  
  gesamtDurBox.value = daten.gesamtDurchschnitt;
  stufeBox.value = daten.stufe;

  
  rowsContainer.innerHTML = ''; // Alle bisherigen Zeilen löschen

  daten.schuelerDaten.forEach(item => {
    const row = document.createElement('div');
    row.className = 'box-container-row';
    row.innerHTML = `
      <span class="circle-with-minus" onclick="removeRow(this)">&#8722;</span>
      <input type="checkbox" ${item.aktiviert ? 'checked' : ''} style="margin-right: 10px;" onchange="updateGesamtdurchschnitt()">
      <input class="box" type="text" value="${item.name}">
      ${item.zensuren.map(zensur => `<input class="boxzens" type="number" value="${zensur}" min="0" max="15" oninput="calculateAverage(this)">`).join('')}
      <input class="box" type="text" value="${item.durchschnitt}" readonly placeholder="Durchschnitt">
    `;
    rowsContainer.appendChild(row);
  });

 
  updateGesamtdurchschnitt();
}


document.addEventListener('DOMContentLoaded', function () {
  var schuelerName = getSchueler();  // schuelername kommt vom ersten dokuemtnt
  if(schuelerName == null) schuelerName = "Paul Paulus"

  const schuelerDaten = getSchuelerDaten(schuelerName);
  if (schuelerDaten) {
    fillData(schuelerDaten);  // Wenn Daten vorhanden sind, Felder füllen
  } else {
    console.log("Keine Daten für diesen Schüler in der Datenbank gefunden.");
  }
});
function getSchueler() {
    const urlParams = new URLSearchParams(window.location.search);
    schueler = urlParams.get("Schueler");
    if(schueler != "null"){
      document.getElementById('schuelerholder').value = schueler;
    }
    
    return urlParams.get("Schueler");
  }

    
</script>

</body>
</html>
